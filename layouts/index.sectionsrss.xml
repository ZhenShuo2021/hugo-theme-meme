{{- $pctx := . -}}
{{- if .IsHome -}}
  {{ $pctx = .Site }}
{{- end -}}

{{- $pages := slice -}}
{{- if or $.IsHome $.IsSection -}}
  {{- $pages = $pctx.RegularPages -}}
{{- else -}}
  {{- $pages = $pctx.Pages -}}
{{- end -}}

{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
  {{- $pages = $pages | first $limit -}}
{{- end -}}

{{- $siteTitle := .Site.Title -}}
{{- $pageTitle := .Title -}}
{{- $isHomePage := eq $pageTitle $siteTitle -}}
{{- $title := cond $isHomePage $siteTitle (printf "%s on %s" (cond $pageTitle $pageTitle "") $siteTitle) -}}

{{- $rssDescription := printf "Recent content %son %s" (cond (ne $pageTitle $siteTitle) (printf "in %s " (cond $pageTitle $pageTitle "")) "") $siteTitle -}}

{{- $authorEmail := .Site.Params.Author.email -}}
{{- $authorName := .Site.Params.Author.name -}}
{{- $authorString := cond $authorName (printf "%s (%s)" $authorEmail $authorName) $authorEmail -}}

{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
{{ with .Site.Params.enableRSSXSL }}
  {{- printf "<?xml-stylesheet href=\"rss-style.xsl\" type=\"text/xsl\"?>" | safeHTML }}
{{ end }}
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>{{ $title }}</title>
    <link>{{ .Permalink }}</link>
    <description>{{ $rssDescription }}</description>
    <generator>Hugo {{ hugo.Version }} https://gohugo.io/</generator>
    <language>{{ site.LanguageCode }}</language>

    {{- with $authorEmail -}}
      <managingEditor>{{ $authorString }}</managingEditor>
    {{- end -}}

    {{- with $authorEmail -}}
      <webMaster>{{ $authorString }}</webMaster>
    {{- end -}}

    {{- if .Site.Params.footer.showCopyright | default true -}}
      <copyright>
        {{- with replace .Site.Params.copyright "{ year }" now.Year -}}
          {{ . }}
        {{- else -}}
          Â© {{ now.Format "2006" }} {{ .Site.Params.Author.name }}
        {{- end -}}
      </copyright>
    {{- end -}}

    {{- if not .Date.IsZero -}}
      <lastBuildDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</lastBuildDate>
    {{- end -}}

    {{- with .OutputFormats.Get "SectionsRSS" -}}
      {{ printf "<atom:link href=%q rel=\"self\" type=%q />" .Permalink .MediaType | safeHTML }}
    {{- end -}}

    {{ if and (.Site.Params.rssnext.feedId) (.Site.Params.rssnext.userId) }}
      <follow_challenge>
        <feedId>{{ .Site.Params.rssnext.feedId }}</feedId>
        <userId>{{ .Site.Params.rssnext.userId }}</userId>
      </follow_challenge>
    {{ end }}

    {{ range $pages }}
      <item>
        <title>{{ .Title }}</title>
        <link>{{ .Permalink }}</link>
        <pubDate>{{ .Date.Format "2006-01-02T15:04:05Z" | safeHTML }}</pubDate>

        {{- with .Site.Params.Author.email -}}
          <author>{{ $authorString }}</author>
        {{- end -}}
        <guid>{{ .Permalink }}</guid>
        <description>{{ .Summary | replaceRE `<h[1-6][^>]*>.*?</h[1-6]>` "" | replaceRE `<[^>]*>` "" | replaceRE `^\s*` "" | replaceRE `\n.*` "" }}</description>
        {{ range ( where .Site.RegularPages ".RelPermalink" .RelPermalink | first 1 ) }}
          {{- $images := .Resources.ByType "image" -}}
          {{- $featured := $images.GetMatch "*feature*" -}}
          {{- if not $featured -}}
            {{- $featured = $images.GetMatch "{*cover*,*thumbnail*}" -}}
          {{- end -}}
          {{- with $featured -}}
            <media:content xmlns:media="http://search.yahoo.com/mrss/" url="{{ $featured.Permalink  }}" />
          {{- end -}}
        {{- end -}}
      </item>
    {{- end -}}
  </channel>
</rss>
